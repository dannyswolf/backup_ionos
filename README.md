# ================================================================================
# ΟΔΗΓΟΣ ΕΓΚΑΤΑΣΤΑΣΗΣ, ΑΣΦΑΛΕΙΑΣ & ΠΡΩΤΟΚΟΛΛΟΥ ΣΥΣΤΗΜΑΤΟΣ (IONOS SERVER)
# ================================================================================

--------------------------------------------------------------------------------
ΜΕΡΟΣ Α: ΡΥΘΜΙΣΗ IONOS SERVER (TARGET)
--------------------------------------------------------------------------------

1. ΕΓΚΑΤΑΣΤΑΣΗ ΕΡΓΑΛΕΙΩΝ (System Requirements)
--------------------------------------------------------------------------------
Εκτελέστε την παρακάτω εντολή για την εγκατάσταση των απαραίτητων εργαλείων για το 
Backup, το Security και το Monitoring:

sudo apt update && sudo apt install -y zip ipset ufw fail2ban coreutils findutils logrotate

ΑΝΑΛΥΣΗ ΠΑΚΕΤΩΝ:
- zip: Χρησιμοποιείται από το script για τη δημιουργία του τελικού πακέτου backup. 
  Η επιλογή -1 στον κώδικα διασφαλίζει ελάχιστη χρήση CPU κατά τη συμπίεση.
- ipset: Διαχείριση της λίστας "greece" (461+ εγγραφές). Επιτρέπει στο Firewall να 
  ελέγχει χιλιάδες IPs με μία μόνο κίνηση, χωρίς να επιβαρύνει τον επεξεργαστή.
- coreutils: Περιέχει την εντολή 'stat' για την ανάγνωση δικαιωμάτων και την 'tee' 
  για την ασφαλή εγγραφή logs σε προστατευμένα μονοπάτια.
- findutils: Περιέχει την εντολή 'find' η οποία σαρώνει τους φακέλους /etc/apache2/ 
  και /var/www/ για την καταγραφή των permissions στο αρχείο files_permissions.txt.
- fail2ban: Προστασία από Brute Force. Το script παίρνει backup τη βάση δεδομένων 
  (.sqlite3) για να διατηρηθεί το ιστορικό των bans μετά από format ή restore.
- logrotate: Διαχείριση μεγέθους logs. Διασφαλίζει ότι τα αρχεία *.log που 
  συμπεριλαμβάνονται στο backup είναι ανακυκλωμένα και δεν καταλαμβάνουν άσκοπο χώρο.
- ufw: Το "τείχος" προστασίας. Ο κώδικας βασίζεται στην ύπαρξη του UFW για τον 
  έλεγχο της πρόσβασης στις θύρες 80, 443 και 8086.

2. ΡΥΘΜΙΣΗ ΑΣΦΑΛΕΙΑΣ (Privilege Escalation)
--------------------------------------------------------------------------------
Η ρύθμιση του 'visudo' είναι η "καρδιά" της αυτοματοποίησης. Περιορίζουμε τις 
εντολές μόνο εκεί που χρειάζεται (Αρχή του Ελάχιστου Προνομίου).

Εντολή: sudo visudo
Προσθήκη στο τέλος του αρχείου:
ονομα_χρήστη ALL=(ALL) NOPASSWD: /usr/bin/find, /usr/bin/zip, /usr/sbin/ipset, /usr/bin/stat, /usr/bin/journalctl, /usr/bin/rm -f /tmp/*, /usr/bin/tee /tmp/*, /bin/cp * /tmp/*

ΓΙΑΤΙ ΑΥΤΗ Η ΣΥΝΔΕΣΗ;
- journalctl & tee: Επιτρέπουν στο script να εξάγει το log του συστήματος των 
  τελευταίων 24 ωρών και να το αποθηκεύει στο /tmp/ χωρίς να έχει ο χρήστης 
  πλήρη πρόσβαση στα logs του root.
- cp & rm: Επιτρέπουν την προσωρινή μεταφορά ευαίσθητων αρχείων (όπως το 
  fail2ban.sqlite3) στο /tmp/ για συμπίεση και τον άμεσο καθαρισμό τους, 
  προστατεύοντας τα πρωτότυπα αρχεία στο /etc/.

3. IPSET: Η ΔΙΑΦΟΡΑ "ΣΤΑΤΙΚΟΥ" ΚΑΙ "ΖΩΝΤΑΝΟΥ"
--------------------------------------------------------------------------------
Είναι κρίσιμο να κατανοούμε γιατί παίρνουμε και τα δύο αρχεία στο backup:
- /etc/ipset.conf (Η Υπόσχεση): Περιέχει τις ρυθμίσεις που έχουν οριστεί να 
  φορτώνουν κατά την εκκίνηση του Server.
- /tmp/ipset_backup.conf (Η Πραγματικότητα): Αυτή είναι η "ζωντανή" μνήμη RAM του 
  Firewall. Αν το Fail2Ban έχει προσθέσει μια νέα IP στη λίστα ban, αυτή 
  υπάρχει μόνο εδώ. Το script την εξάγει με την εντολή 'ipset save'.
- [DEBUG Σημείωση]: Αν η μεταβλητή DEBUG είναι True και το αρχείο στο /tmp/ 
  βγει 0kb, το script εκτυπώνει προειδοποίηση ότι το IPSet layer είναι ανενεργό.

4. SYSTEM JOURNAL: ΤΟ "ΜΑΥΡΟ ΚΟΥΤΙ"
--------------------------------------------------------------------------------
- Αρχείο: /tmp/full_system_journal.txt
- Λειτουργία: Το script εκτελεί την εντολή 'journalctl --since "24 hours ago"'.
- Περιεχόμενο: Καταγράφει SSH logins, Docker container crashes, και Fail2Ban 
  triggers. 
- Σύνδεση: Επειδή ο IONOS (Debian 12) χρησιμοποιεί το systemd-journald, αυτό το 
  αρχείο είναι η ΜΟΝΑΔΙΚΗ πηγή αλήθειας για τη διάγνωση προβλημάτων που 
  προηγήθηκαν ενός backup.

5. ΔΙΑΧΕΙΡΙΣΗ LOGS (Logrotate & Docker)
--------------------------------------------------------------------------------
Για να μην διογκώνονται τα logs του Docker και "πνίγουν" το backup:
- Σύνδεση με logrotate: Το script βασίζεται στο ότι το σύστημα τρέχει το 
  logrotate καθημερινά, ώστε να μην κάνει backup αρχεία log πολλών Gigabytes.
- Ρύθμιση Docker (daemon.json): Προτείνεται ο περιορισμός των logs (max-size: 10m) 
  για να διατηρείται η ταχύτητα μεταφοράς (SFTP) σε υψηλά επίπεδα.
- Σύνδεση: Το script κάνει backup τον φάκελο /var/log/apache2/ ο οποίος 
  περιέχει τα access logs που χρειάζονται για το Fail2Ban jail [apache-badbots].

--------------------------------------------------------------------------------
ΜΕΡΟΣ Β: ΡΥΘΜΙΣΗ QNAP (CONTROLLER)
--------------------------------------------------------------------------------

1. ΕΓΚΑΤΑΣΤΑΣΗ PYTHON & ΒΙΒΛΙΟΘΗΚΩΝ
--------------------------------------------------------------------------------
Το QNAP πρέπει να διαθέτει Python 3.9+. Ανοίξτε το Terminal (SSH) του QNAP και 
εκτελέστε:

sudo apt install python3-paramiko python3-dotenv

ΑΝΑΛΥΣΗ ΒΙΒΛΙΟΘΗΚΩΝ:
- paramiko: Είναι η "καρδιά" του script. Επιτρέπει στην Python να ανοίγει SSH 
  κανάλια, να εκτελεί εντολές sudo και να μεταφέρει αρχεία μέσω SFTP.
- python-dotenv: Διαβάζει το αρχείο .env. Χωρίς αυτήν, οι μεταβλητές όπως 
  IONOS_IP και SMTP_PASSWORD θα παραμείνουν κενές.

2. ΔΗΜΙΟΥΡΓΙΑ ΑΡΧΕΙΟΥ ΡΥΘΜΙΣΕΩΝ (.env)
--------------------------------------------------------------------------------
Στον ίδιο φάκελο που βρίσκεται το backup_ionos.py, δημιουργήστε ένα αρχείο 
με όνομα .env. Αυτό είναι το "κλειδί" για να συνδεθεί το QNAP με τον IONOS.

ΠΕΡΙΕΧΟΜΕΝΟ .env (Πρότυπο):
DEBUG=True
# --- ΡΥΘΜΙΣΕΙΣ ΣΥΝΔΕΣΗΣ ---
# Η διεύθυνση IP του απομακρυσμένου σέρβερ IONOS
IONOS_IP=xxx.xxx.xxx.xxx
# Το όνομα χρήστη για τη σύνδεση SSH στον σέρβερ
IONOS_USER=
# Το κλειδί πρόσβασης για τον χρήστη 
SSH_KEY_PATH=
# Η διαδρομή του project στον IONOS
REMOTE_BEE_DIR=
# Ο προσωρινός φάκελος αποθήκευσης αρχείων στον IONOS
REMOTE_ZIP_TMP=
# Η τοπική διαδρομή στο QNAP για τα αντίγραφα ασφαλείας
LOCAL_BACKUP_DIR=

# --- ΡΥΘΜΙΣΕΙΣ ΚΑΜΕΡΩΝ ---
# Η διαδρομή των αρχείων της κάμερας VIGI στον IONOS
REMOTE_VIGI_DIR=
# Η τοπική διαδρομή στο QNAP για την αποθήκευση των καμερών
LOCAL_VIGI_DIR=
# Ο αριθμός των ταυτόχρονων εργασιών για τη μεταφορά αρχείων
MAX_WORKERS=

# --- ΔΙΑΔΡΟΜΕΣ LOG FILES ---
# Πληροφορίες: Ορίζουμε το κεντρικό αρχείο καταγραφής όπου θα συγκεντρώνονται όλα τα logs.
# ΣΥΝΔΕΣΗ: Χρησιμοποιούμε μία διαδρομή (SYSTEM_LOG) και για τις δύο υπηρεσίες για ευκολότερο έλεγχο.
SYSTEM_LOG=

# --- EMAIL SETTINGS ---
SMTP_SERVER=
SMTP_PORT=
SMTP_USER=
SMTP_PASS=
EMAIL_RECEIVER=


3. ΡΥΘΜΙΣΗ SSH KEYS (Το σημαντικότερο βήμα)
--------------------------------------------------------------------------------
Για να μην σταματάει το script ζητώντας κωδικό SSH, πρέπει το QNAP να έχει 
εμπιστοσύνη στον IONOS.

Εντολές στο QNAP:
1. ssh-keygen -t ed25519 -f ~/.ssh/ονομα_χρήστη_id_ed25519_ionos_key  (Αν δεν έχετε ήδη κλειδί)
2. ssh-copy-id -i ~/.ssh/ονομα_χρήστη_id_ed25519_ionos_key.pub ονομα_χρήστη@IONOS_IP

ΣΥΝΔΕΣΗ ΜΕ ΤΟΝ ΚΩΔΙΚΑ:
Ο κώδικας στην κλάση 'IonosBackup' χρησιμοποιεί την εντολή:
key = paramiko.Ed25519Key.from_private_key_file(ssh_key_path)
Αν το κλειδί έχει password (passphrase), το script θα αποτύχει. Το κλειδί 
πρέπει να είναι "unprotected" για την αυτοματοποίηση.

4. ΠΡΟΓΡΑΜΜΑΤΙΣΜΟΣ (Crontab)
--------------------------------------------------------------------------------
Για να εκτελείται το script αυτόματα (π.χ. κάθε 15 λεπτά ώστε να πιάνει και 
το παράθυρο των 23:55), προσθέστε στο crontab του QNAP:

55 * * * * /usr/bin/python3 /home/ονομα_χρήστη/Backups/backup_ionos.py >> /home/ονομα_χρήστη/Backups/cron_system_errors.log 2>&1
--------------------------------------------------------------------------------
ΜΕΡΟΣ Γ: ΠΡΩΤΟΚΟΛΛΟ ΕΠΑΝΑΦΟΡΑΣ (RESTORE)
--------------------------------------------------------------------------------

1. Αποσυμπίεση: sudo unzip backup_file.zip -d /
2. IPSet Restore: sudo ipset restore < ipset_backup.conf (Επαναφέρει το Firewall).
3. Permissions: Το αρχείο files_permissions.txt είναι ο "χάρτης". Εκτελέστε:
   while read -r path perm owner group; do 
     sudo chmod "$perm" "$path"; 
     sudo chown "$owner:$group" "$path"; 
   done < files_permissions.txt
4. Docker Restart: cd /home/ονομα_χρήστη/compose && docker-compose up -d
# ================================================================================
